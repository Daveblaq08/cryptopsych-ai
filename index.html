<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CryptoPsych — Psychometric Market Mirror (Prototype)</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #0b1220;
            --muted: #94a3b8;
            --accent: #7c3aed
        }

        * {
            box-sizing: border-box;
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #071029 0%, #07182a 100%);
            color: #e6eef8;
            min-height: 100vh
        }

        .wrap {
            max-width: 1100px;
            margin: 32px auto;
            padding: 20px
        }

        header {
            display: flex;
            align-items: center;
            gap: 16px
        }

        header h1 {
            margin: 0;
            font-size: 20px
        }

        .grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 18px;
            margin-top: 18px
        }

        .card {
            background: var(--card);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(2, 6, 23, .6)
        }

        nav .nav-item {
            display: block;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 6px;
            color: var(--muted);
            text-decoration: none
        }

        nav .nav-item.active {
            background: rgba(255, 255, 255, .03);
            color: #fff
        }

        .hz {
            height: 12px
        }

        .big {
            font-size: 18px
        }

        .muted {
            color: var(--muted)
        }

        .btn {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--accent), #5b21b6);
            color: white;
            text-decoration: none;
            cursor: pointer;
            border: 0
        }

        label {
            display: block;
            margin-top: 10px;
            font-size: 13px
        }

        input[type='range'] {
            width: 100%
        }

        .score {
            font-weight: 700;
            font-size: 28px
        }

        .scenario {
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, .02);
            margin-bottom: 10px
        }

        .sim-controls {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .log {
            background: #020617;
            padding: 10px;
            border-radius: 8px;
            height: 180px;
            overflow: auto;
            font-size: 13px
        }

        canvas {
            width: 100%;
            height: 160px;
            border-radius: 8px;
            background: #081126
        }

        .footer {
            margin-top: 18px;
            font-size: 12px;
            color: var(--muted)
        }

        @media (max-width:900px) {
            .grid {
                grid-template-columns: 1fr
            }

            .wrap {
                padding: 12px
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <div
                style="width:56px;height:56px;background:linear-gradient(135deg,#7c3aed,#06b6d4);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700">
                CP</div>
            <div>
                <h1>CryptoPsych — Psychometric Market Mirror (Prototype)</h1>
                <div class="muted">Prototype: HTML-first interactive demo. No backend required.</div>
            </div>
        </header>

        <div class="grid">
            <aside class="card">
                <nav>
                    <a class="nav-item active" data-view="profile">Profile & Psychometrics</a>
                    <a class="nav-item" data-view="simulator">Simulator</a>
                    <a class="nav-item" data-view="dashboard">Dashboard</a>
                    <a class="nav-item" data-view="settings">Settings & Privacy</a>
                </nav>
                <div class="hz"></div>
                <div class="card" style="background:transparent;padding:0">
                    <div class="muted">Quick tips</div>
                    <ul class="muted" style="padding-left:14px;margin-top:8px">
                        <li>Complete the psychometric sliders to customize simulations.</li>
                        <li>Run scenarios and watch the decision log for explanations.</li>
                        <li>Data is stored locally in your browser (can be wired to a backend later).</li>
                    </ul>
                </div>
            </aside>

            <main>
                <section id="profile" class="card view">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div class="muted">Step 1</div>
                            <div class="big">Your psychometric profile</div>
                        </div>
                        <div>
                            <button class="btn" id="saveProfile">Save profile</button>
                        </div>
                    </div>

                    <p class="muted" style="margin-top:6px">Adjust sliders to reflect your tendencies — be honest for
                        best results.</p>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
                        <div>
                            <label>Risk Tolerance <span class="muted">(low → high)</span></label>
                            <input id="risk" type="range" min="0" max="100" value="50">
                        </div>

                        <div>
                            <label>Loss Aversion <span class="muted">(how badly losses hurt)</span></label>
                            <input id="lossAversion" type="range" min="0" max="100" value="60">
                        </div>

                        <div>
                            <label>Impulsivity <span class="muted">(fast reflexes vs deliberation)</span></label>
                            <input id="impulsivity" type="range" min="0" max="100" value="40">
                        </div>

                        <div>
                            <label>Social Susceptibility <span class="muted">(influence from crowd/news)</span></label>
                            <input id="social" type="range" min="0" max="100" value="45">
                        </div>

                        <div style="grid-column:1/3">
                            <label>Confidence <span class="muted">(self-assessed)</span></label>
                            <input id="confidence" type="range" min="0" max="100" value="55">
                        </div>
                    </div>

                    <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
                        <div>
                            <div class="muted">Profile score</div>
                            <div class="score" id="profileScore">—</div>
                        </div>
                        <div style="flex:1">
                            <canvas id="radar"></canvas>
                        </div>
                    </div>
                </section>

                <section id="simulator" class="card view" style="display:none">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div class="muted">Step 2</div>
                            <div class="big">Run market scenarios</div>
                        </div>
                        <div>
                            <button class="btn" id="runSim">Run simulation</button>
                        </div>
                    </div>

                    <p class="muted" style="margin-top:6px">Choose or randomly generate a scenario. The system will
                        simulate a sequence of decision points and explain the rationale.</p>

                    <div style="display:flex;gap:12px;margin-top:12px">
                        <div style="flex:1">
                            <label>Select scenario</label>
                            <select id="scenarioSelect"
                                style="width:100%;padding:8px;border-radius:8px;background:#071026;color:#e6eef8;border:1px solid rgba(255,255,255,.03)">
                                <option value="fomo">FOMO pump — sudden social traction</option>
                                <option value="flashdrop">Flash drop — sudden 25%+ decline in 24h</option>
                                <option value="slowBear">Slow bear market — persistent downtrend</option>
                                <option value="newsShock">News shock — regulatory negative headline</option>
                                <option value="custom">Random / custom</option>
                            </select>
                        </div>
                        <div style="width:190px">
                            <label>Simulation length (steps)</label>
                            <input id="steps" type="number" min="3" max="20" value="8"
                                style="width:100%;padding:8px;border-radius:8px;background:#071026;color:#e6eef8;border:1px solid rgba(255,255,255,.03)">
                        </div>
                    </div>

                    <div style="margin-top:12px">
                        <div class="muted">Scenario preview</div>
                        <div id="scenarioPreview" class="scenario">—</div>
                    </div>

                    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
                        <div>
                            <div class="muted">Decision log</div>
                            <div id="log" class="log">No simulation run yet.</div>
                        </div>

                        <div>
                            <div class="muted">Simulation summary</div>
                            <div style="margin-top:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,.02)">
                                <div>Final disposition: <b id="finalAction">—</b></div>
                                <div style="margin-top:8px">Risk exposure: <span id="exposure">—</span></div>
                                <div style="margin-top:8px">Emotional volatility: <span id="volatility">—</span></div>
                            </div>
                            <div style="margin-top:12px">
                                <button class="btn" id="explainBtn">Explain decisions</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="dashboard" class="card view" style="display:none">
                    <div class="muted">Step 3</div>
                    <div class="big">Dashboard & insights</div>
                    <p class="muted" style="margin-top:6px">Historic runs are stored locally. Use them to track
                        improvements.</p>

                    <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
                        <div style="flex:1">
                            <label>Saved runs</label>
                            <div id="savedRuns"></div>
                        </div>
                        <div style="width:260px">
                            <label>Compare to population (mock)</label>
                            <div style="padding:10px;border-radius:8px;background:rgba(255,255,255,.02)">You're more
                                patient than 62% of sample users.</div>
                        </div>
                    </div>
                </section>

                <section id="settings" class="card view" style="display:none">
                    <div class="muted">Privacy & settings</div>
                    <div class="big">Local-first data</div>
                    <p class="muted" style="margin-top:6px">This prototype stores everything in your browser's
                        localStorage. When you move to a hosted version we will add secure server-side storage and
                        opt-in data sharing.</p>

                    <div style="margin-top:12px">
                        <label><input id="optShare" type="checkbox"> Opt-in to anonymous population comparison
                            (mock)</label>
                    </div>

                    <div style="margin-top:12px">
                        <button class="btn" id="clearData">Clear local data</button>
                    </div>
                </section>

                <div class="footer">
                    <section id="ai-features" class="card view" style="margin-top:18px">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div class="muted">AI-powered features</div>
                                <div class="big">Trading Coach • Strategy Generator • Chat Assistant</div>
                            </div>
                        </div>

                        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
                            <div>
                                <div class="muted">AI Chat Assistant</div>
                                <div
                                    style="margin-top:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,.02)">
                                    <div id="chatLog"
                                        style="height:220px;overflow:auto;background:#020617;padding:8px;border-radius:8px;color:#dbeafe;font-size:13px">
                                        No messages yet.</div>
                                    <div style="display:flex;gap:8px;margin-top:8px">
                                        <input id="chatInput" placeholder="Ask the Sentient Dobby assistant..."
                                            style="flex:1;padding:8px;border-radius:8px;background:#071026;color:#e6eef8;border:1px solid rgba(255,255,255,.03)" />
                                        <button class="btn" id="sendChat">Send</button>
                                    </div>
                                </div>

                                <div style="margin-top:12px">
                                    <div class="muted">AI Trading Coach</div>
                                    <div
                                        style="margin-top:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,.02)">
                                        <div style="display:flex;gap:8px;margin-bottom:8px">
                                            <select id="coachPrompt"
                                                style="flex:1;padding:8px;border-radius:8px;background:#071026;color:#e6eef8;border:1px solid rgba(255,255,255,.03)">
                                                <option value="calm_down">I’m panicking after a drop — what should I do?
                                                </option>
                                                <option value="evaluate_trade">Should I buy more during this dip?
                                                </option>
                                                <option value="bias_report">Explain my main behavioral biases</option>
                                                <option value="discipline_plan">Give me a discipline plan to avoid
                                                    impulsive trades</option>
                                            </select>
                                            <button class="btn" id="askCoach">Ask Coach</button>
                                        </div>
                                        <div id="coachAnswer" style="margin-top:8px" class="muted">No answer yet.</div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="muted">Strategy Generator</div>
                                <div
                                    style="margin-top:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,.02)">
                                    <div style="margin-bottom:8px">Generate a personalized short-term strategy based on
                                        your profile and a chosen scenario.</div>
                                    <label>Scenario</label>
                                    <select id="stratScenario"
                                        style="width:100%;padding:8px;border-radius:8px;background:#071026;color:#e6eef8;border:1px solid rgba(255,255,255,.03)">
                                        <option value="fomo">FOMO pump</option>
                                        <option value="flashdrop">Flash drop</option>
                                        <option value="slowBear">Slow bear</option>
                                        <option value="newsShock">News shock</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                    <div style="margin-top:8px;display:flex;gap:8px">
                                        <button class="btn" id="genStrat">Generate Strategy</button>
                                        <button class="btn" id="saveStrat">Save</button>
                                    </div>
                                    <div id="strategyOutput"
                                        style="margin-top:10px;min-height:120px;background:#020617;padding:8px;border-radius:8px;color:#dbeafe;overflow:auto">
                                        No strategy yet.</div>
                                </div>

                                <div style="margin-top:12px">
                                    <div class="muted">Quick tips</div>
                                    <ul class="muted" style="padding-left:14px;margin-top:8px">
                                        <li>Keep API keys private — stored locally here for prototyping.</li>
                                        <li>Strategies are suggestions: validate with your own research.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- ===== Feature Highlights Section ===== -->
                    <section class="card" style="margin-top: 20px;">
                        <h2 class="big">Why use CryptoPsych?</h2>
                        <p class="muted">A smarter way to understand your trading behavior and improve decision-making.
                        </p>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 14px;">

                            <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 10px;">
                                <h3>🧭 AI Trading Mirror</h3>
                                <p class="muted">Simulates how *you* would trade based on your psychology.</p>
                            </div>

                            <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 10px;">
                                <h3>⚡ Bias Detector</h3>
                                <p class="muted">Reveals moments when emotions like fear or greed influence decisions.
                                </p>
                            </div>

                            <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 10px;">
                                <h3>📊 Behavior Dashboard</h3>
                                <p class="muted">Track progress over time and build stronger trading discipline.</p>
                            </div>

                        </div>
                    </section>


                    <div class="footer">Prototype • made for exploration — can be extended to use LLMs, on-chain data &
                        secure backends.</div>
                </div>
            </main>
        </div>
    </div>

    <script>
        /* --- Minimal profiler -> simulation mapping --- */
        const qs = (s) => document.querySelector(s);
        const profileFields = ['risk', 'lossAversion', 'impulsivity', 'social', 'confidence'];

        function readProfile() {
            const p = {};
            profileFields.forEach(f => p[f] = Number(qs('#' + f).value));
            p.score = Math.round((p.risk + (100 - p.lossAversion) + (100 - p.impulsivity) + (100 - p.social) + p.confidence) / 5);
            return p;
        }

        function renderProfile() {
            const p = readProfile();
            qs('#profileScore').textContent = p.score;
            drawRadar(p);
        }

        profileFields.forEach(f => qs('#' + f).addEventListener('input', renderProfile));
        renderProfile();

        /* Basic radar using canvas (no libs) */
        function drawRadar(p) {
            const c = qs('#radar');
            c.width = 600; c.height = 220;
            const ctx = c.getContext('2d');
            ctx.clearRect(0, 0, c.width, c.height);
            const labels = ['Risk', 'LossAv', 'Impuls', 'Social', 'Conf'];
            const vals = [p.risk, p.lossAversion, p.impulsivity, p.social, p.confidence];
            const cx = 120, cy = 110, r = 80;
            ctx.strokeStyle = 'rgba(255,255,255,.06)'; ctx.fillStyle = 'rgba(124,58,237,.12)'; ctx.lineWidth = 1;
            // grid
            for (let g = 4; g >= 1; g--) {
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const a = (i / 5) * Math.PI * 2 - Math.PI / 2;
                    const rr = r * (g / 4);
                    const x = cx + Math.cos(a) * rr, y = cy + Math.sin(a) * rr;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.closePath(); ctx.stroke();
            }
            // data
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const a = (i / 5) * Math.PI * 2 - Math.PI / 2;
                const rr = r * (vals[i] / 100);
                const x = cx + Math.cos(a) * rr, y = cy + Math.sin(a) * rr;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.closePath(); ctx.fill(); ctx.stroke();
            // labels
            ctx.fillStyle = 'rgba(230,238,248,.9)'; ctx.font = '12px sans-serif';
            for (let i = 0; i < 5; i++) {
                const a = (i / 5) * Math.PI * 2 - Math.PI / 2;
                const x = cx + Math.cos(a) * (r + 18), y = cy + Math.sin(a) * (r + 18);
                ctx.fillText(labels[i], x - 10, y + 4);
            }
        }

        /* Navigation */
        document.querySelectorAll('nav .nav-item').forEach(a => a.addEventListener('click', e => {
            document.querySelectorAll('nav .nav-item').forEach(x => x.classList.remove('active'));
            e.target.classList.add('active');
            const view = e.target.dataset.view;
            document.querySelectorAll('.view').forEach(v => v.style.display = v.id === view ? 'block' : 'none');
        }));

        /* Profile saving */
        qs('#saveProfile').addEventListener('click', () => {
            localStorage.setItem('cp_profile', JSON.stringify(readProfile()));
            alert('Profile saved locally.');
        });

        // Load profile if present
        const saved = localStorage.getItem('cp_profile');
        if (saved) {
            try { const p = JSON.parse(saved); profileFields.forEach(f => qs('#' + f).value = p[f]); renderProfile(); } catch (e) { }
        }

        /* Scenario generation */
        function previewScenario(key) {
            const mapping = {
                'fomo': 'A token gets massive social traction; volume spikes and price quickly rises 40% in 48h. Expect emotional FOMO points and chatter.',
                'flashdrop': 'A large whale sells and price drops 25% within a day. Fear and rapid stop-loss triggers are likely.',
                'slowBear': 'Slow consistent downtrend over weeks; volatility low but conviction erodes.',
                'newsShock': 'A sudden regulatory headline hitting major country; liquidity vanishes for an hour.'
            };
            return mapping[key] || 'A randomized mixed scenario with alternating pumps and drops.';
        }

        qs('#scenarioSelect').addEventListener('change', () => qs('#scenarioPreview').textContent = previewScenario(qs('#scenarioSelect').value));
        qs('#scenarioPreview').textContent = previewScenario(qs('#scenarioSelect').value);

        /* Core simulation logic (heuristic) */
        function runSimulation() {
            const profile = readProfile();
            const scenario = qs('#scenarioSelect').value;
            const steps = Math.max(3, Math.min(20, Number(qs('#steps').value) || 8));
            const log = [];
            let exposure = 0.5; // 0..1 fraction of portfolio in crypto
            let emotion = 0.5; // 0..1

            // map profile traits to coefficients
            const riskCoeff = profile.risk / 100;
            const lossCoeff = profile.lossAversion / 100;
            const impuls = profile.impulsivity / 100;
            const social = profile.social / 100;
            const conf = profile.confidence / 100;

            for (let i = 0; i < steps; i++) {
                // generate a market move influenced by scenario
                let move = (Math.random() * 2 - 1) * (0.06 + (i / steps) * 0.08); // -..+
                if (scenario === 'fomo') move += 0.06 * Math.random();
                if (scenario === 'flashdrop') move -= (i === 1 ? 0.18 : 0.05 * Math.random());
                if (scenario === 'slowBear') move -= 0.02 + 0.02 * Math.random();
                if (scenario === 'newsShock' && Math.random() < 0.25) move -= 0.25 * Math.random();

                // emotional update: social amplifies, loss aversion amplifies negative moves
                emotion += (move < 0 ? Math.abs(move) * lossCoeff : move * social) * (0.6 - conf * 0.3);
                emotion = Math.max(0, Math.min(1, emotion));

                // decision: buy/hold/sell probability influenced by risk, impulsivity, emotion
                const sellPressure = emotion * (0.6 + lossCoeff * 0.6) * (0.4 + (1 - riskCoeff) * 0.6);
                const buyPressure = (1 - emotion) * (0.4 + riskCoeff * 0.6) * (0.4 + conf * 0.6);
                const impulseFactor = 0.4 * impuls * (Math.random() * 1.8);

                let action = 'hold';
                if (buyPressure + impulseFactor > sellPressure + Math.random() * 0.5) {
                    exposure = Math.min(1, exposure + 0.1 * (0.5 + riskCoeff)); action = 'buy';
                } else if (sellPressure + impulseFactor > buyPressure + Math.random() * 0.6) {
                    exposure = Math.max(0, exposure - 0.15 * (0.5 + lossCoeff)); action = 'sell';
                }

                // small heuristics to avoid flip-flopping too fast
                if (Math.random() < 0.03) action = 'hold';

                const explanation = `Step ${i + 1}: market move ${(move * 100).toFixed(1)}% → emotion ${(emotion * 100).toFixed(0)}% → decided to ${action}`;
                log.push({ step: i + 1, move, emotion, exposure, action, explanation });
            }

            return { log, exposure, volatility: Math.round(Math.random() * 40 + 10) };
        }

        qs('#runSim').addEventListener('click', () => {
            qs('#log').textContent = 'Running simulation...';
            setTimeout(() => {
                const out = runSimulation();
                qs('#log').innerHTML = out.log.map(l => `<div style="margin-bottom:8px">${l.explanation}</div>`).join('');
                qs('#finalAction').textContent = out.log[out.log.length - 1].action.toUpperCase();
                qs('#exposure').textContent = Math.round(out.exposure * 100) + '%';
                qs('#volatility').textContent = out.volatility + '%';

                // save run
                const runs = JSON.parse(localStorage.getItem('cp_runs') || '[]');
                runs.unshift({ id: Date.now(), date: new Date().toISOString(), scenario: qs('#scenarioSelect').value, profile: readProfile(), summary: { exposure: out.exposure, volatility: out.volatility } });
                localStorage.setItem('cp_runs', JSON.stringify(runs.slice(0, 50)));
                renderSavedRuns();
            }, 300);
        });

        qs('#explainBtn').addEventListener('click', () => {
            alert('Explanation: each decision is a heuristic result of your profile interacting with market moves. This prototype uses deterministic-but-randomized rules — replace with ML/LLM for richer reasoning.');
        });

        function renderSavedRuns() {
            const runs = JSON.parse(localStorage.getItem('cp_runs') || '[]');
            const el = qs('#savedRuns'); el.innerHTML = '';
            if (runs.length === 0) el.innerHTML = '<div class="muted">No runs yet.</div>';
            runs.forEach(r => {
                const d = document.createElement('div'); d.className = 'scenario'; d.innerHTML = `<div style="font-weight:700">${r.scenario} — ${new Date(r.date).toLocaleString()}</div><div class="muted">Exposure ${Math.round(r.summary.exposure * 100)}% • Vol ${r.summary.volatility}%</div>`;
                el.appendChild(d);
            });
        }
        renderSavedRuns();

        qs('#clearData').addEventListener('click', () => { localStorage.removeItem('cp_profile'); localStorage.removeItem('cp_runs'); alert('Local data cleared.'); location.reload(); });

        // save opt-in
        qs('#optShare').addEventListener('change', () => localStorage.setItem('cp_optin', qs('#optShare').checked));

        // ===== Sentient Dobby Integration =====
        let dobbyApiKey = localStorage.getItem('dobbyApiKey') || '';
        const dobbyEndpoint = 'https://api.sentientdobby.com/v1/chat'; // placeholder

        function setDobbyKey(key) {
            dobbyApiKey = key;
            localStorage.setItem('dobbyApiKey', key);
            const status = document.getElementById('dobby-status');
            if (status) status.textContent = 'API key saved locally';
        }

        async function callDobby(messages) {
            const response = await fetch("http://localhost:5000/api/fireworks", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: messages[messages.length - 1].content })
            });

            const data = await response.json();
            return data;
        }



        window.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('saveDobbyKey');
            if (btn) { btn.onclick = () => setDobbyKey(document.getElementById('dobbyApiKey').value.trim()); }
        });
    </script>
    <script>
        // --- helper: append chat messages to chatLog
        function appendChat(role, text) {
            const log = document.getElementById('chatLog');
            if (!log) return;
            const el = document.createElement('div');
            el.style.marginBottom = '8px';
            el.innerHTML = `<div style="font-size:12px;color:#94a3b8">${role}</div><div style="font-size:14px">${text}</div>`;
            log.appendChild(el);
            log.scrollTop = log.scrollHeight;
        }

        // --- Chat panel send handler
        async function handleChatSend() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim(); if (!text) return;
            appendChat('You', text);
            input.value = '';
            try {
                // keep messages shape general: Dobby wrapper should accept this
                const resp = await callDobby([{ role: 'user', content: text }]);
                // try to extract reply from common response shapes:
                const reply = resp?.choices?.[0]?.message?.content || resp?.answer || JSON.stringify(resp);
                appendChat('Dobby', reply);
            } catch (e) {
                appendChat('System', 'Error contacting Dobby: ' + e.message);
            }
        }

        document.getElementById('sendChat').addEventListener('click', handleChatSend);
        document.getElementById('chatInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') { handleChatSend(); } });

        // --- Coach prompts templates
        const coachPrompts = {
            calm_down: (profile, scenario) => `You are an empathetic trading coach. The user profile: ${JSON.stringify(profile)}. The scenario: ${scenario}. The user is panicking after a drop. Provide a calm, step-by-step action plan (3 steps), one short checklist of actions, and a one-sentence mantra to repeat.`,
            evaluate_trade: (profile, scenario) => `You are a pragmatic trading coach. The user profile: ${JSON.stringify(profile)}. The scenario: ${scenario}. Evaluate whether buying more during a dip is reasonable. Provide a clear risk-aware recommendation with a short rationale.`,
            bias_report: (profile, scenario) => `You are a behavioral analyst. The user profile: ${JSON.stringify(profile)}. The scenario: ${scenario}. Explain the user's main behavioral biases, how they would affect trading decisions in this scenario, and 2 quick remedial actions.`,
            discipline_plan: (profile, scenario) => `You are a trading therapist. The user profile: ${JSON.stringify(profile)}. The scenario: ${scenario}. Provide a 7-day discipline plan to reduce impulsive trades, including triggers and replacement behaviors.`
        };

        async function handleAskCoach() {
            const outEl = document.getElementById('coachAnswer');
            outEl.textContent = 'Thinking...';
            const key = document.getElementById('coachPrompt').value;
            const profile = readProfile();
            const scenario = document.getElementById('scenarioSelect')?.value || document.getElementById('stratScenario')?.value || 'custom';
            const prompt = (coachPrompts[key] || coachPrompts['bias_report'])(profile, scenario);
            try {
                const resp = await callDobby([
                    { role: 'system', content: 'You are Sentient Dobby, an expert behavioral trading assistant.' },
                    { role: 'user', content: prompt }
                ]);
                const reply = resp?.choices?.[0]?.message?.content || resp?.answer || JSON.stringify(resp);
                outEl.textContent = reply;
            } catch (e) {
                outEl.textContent = 'Error: ' + e.message;
            }
        }
        document.getElementById('askCoach').addEventListener('click', handleAskCoach);

        // --- Strategy generation
        async function handleGenStrat() {
            const profile = readProfile();
            const scenario = document.getElementById('stratScenario').value;
            const outEl = document.getElementById('strategyOutput');
            outEl.textContent = 'Generating strategy...';
            const prompt = `You are an expert crypto strategist. Given user profile ${JSON.stringify(profile)} and market scenario ${scenario}, produce a concise 5-point short-term strategy (entry, sizing, stop-loss, take-profit, emotion rules). Keep it short and actionable.`;
            try {
                const resp = await callDobby([
                    { role: 'system', content: 'You are Sentient Dobby, a concise strategist.' },
                    { role: 'user', content: prompt }
                ]);
                const reply = resp?.choices?.[0]?.message?.content || resp?.answer || JSON.stringify(resp);
                outEl.textContent = reply;
            } catch (e) {
                outEl.textContent = 'Error: ' + e.message;
            }
        }
        document.getElementById('genStrat').addEventListener('click', handleGenStrat);

        // --- Save strategy locally
        document.getElementById('saveStrat').addEventListener('click', () => {
            const out = document.getElementById('strategyOutput').textContent;
            if (!out || out === 'No strategy yet.') return alert('No strategy to save');
            const saved = JSON.parse(localStorage.getItem('cp_strats') || '[]');
            saved.unshift({ id: Date.now(), date: new Date().toISOString(), text: out });
            localStorage.setItem('cp_strats', JSON.stringify(saved.slice(0, 50)));
            alert('Strategy saved locally.');
        });
    </script>

</body>

</html>
